<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OpenTTD Online</title>
<meta name="description" content="Play OpenTTD Online instantly in your web browser — no downloads required.">
<meta name="keywords" content="OpenTTD online, play OpenTTD in browser, OpenTTD WebAssembly, Transport Tycoon online, open source transport game">
<meta name="author" content="overgrown-games.com">
<meta property="og:title" content="OpenTTD Online – Play in Your Browser">
<meta property="og:description" content="Play OpenTTD directly in your browser. Build and manage your transport empire online.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://openttdonline.com/">

<meta http-equiv="Content-Security-Policy"
      content="
        default-src 'self' data: blob:;
        script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: blob:;
        font-src 'self' data:;
        object-src 'none';
        worker-src 'self' blob:;
        base-uri 'self';
        connect-src
          'self'
          https://cdn.openttd.org
          https://servers.openttd.org
          https://bananas.openttd.org
          wss://bananas-server.openttd.org
          https://content.openttd.org
          wss://content.openttd.org:3978;
        upgrade-insecure-requests;
      ">
<link rel="icon" type="image/png" href="favicon.png">

<style>
  html,body{margin:0;padding:0;height:100%;width:100%;background:#1a1a1a;overflow:hidden}
  #canvas{width:100%;height:100%;display:block;background:#1a1a1a;cursor:none;z-index:1;position:relative}
  #overlay{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;transition:opacity .4s ease;pointer-events:none;z-index:2}
  #box{max-width:720px;text-align:center;color:#eee;font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  #box h2{margin:.2rem 0 .4rem;font-weight:600;font-size:18px;color:#fff}
  #logo{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);max-width:250px;opacity:0;z-index:2;transition:opacity .6s ease}

  /* --- Toolbar --- */
  #toolbar{
    position:fixed;
    top:54px;left:10px;z-index:3;
    background:rgba(0,0,0,.55);
    border:1px solid #333;border-radius:8px;
    padding:6px 8px;
    backdrop-filter:blur(2px);
    display:none;
    flex-direction:column !important;
    gap:4px !important;
    width:160px !important;
    min-width:160px !important;
    box-sizing:border-box;
  }
  #toolbar button{
    color:#eee;background:#222;border:1px solid #444;border-radius:6px;
    padding:5px 8px;cursor:pointer;width:100%;text-align:left;
    font-size:12.5px;line-height:1.2;transition:background .15s;
  }
  #toolbar button:hover{background:#2b2b2b}

  /* Embed link styling */
  #toolbar a{
    color:#4fc3f7;text-decoration:none;
    text-align:center;font-size:12.5px;margin-top:4px;padding:4px 0;
    border-top:1px solid #333;transition:color .2s;
  }
  #toolbar a:hover{color:#81d4fa;text-decoration:underline}

  /* Toggle button */
  #toolbar-toggle{
    position:fixed;top:10px;left:10px;z-index:4;
    width:38px;height:38px;border-radius:9999px;
    display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.65);color:#eee;border:1px solid #333;
    user-select:none;backdrop-filter:blur(2px);
    opacity:0;animation:fadeIn 0.4s ease forwards 0.3s;
  }
  @keyframes fadeIn { to { opacity:1; } }
  #toolbar-toggle:hover{background:rgba(0,0,0,.78)}
  #toolbar-toggle .icon{font-size:18px;line-height:1}
  #toolbar-toggle[aria-pressed="true"]{outline:2px solid #4caf50;outline-offset:1px}

  #filesystem{
    display:none;position:fixed;bottom:10px;right:10px;
    background:rgba(0,0,0,.6);padding:8px 10px;border-radius:8px;
    color:#fff;font-size:13px;border:1px solid #333;z-index:3
  }
  .error{color:#ff6b6b}

  html, body, canvas, #canvas, * { cursor: none !important; }
  #toolbar, #toolbar *, #toolbar-toggle, #toolbar-toggle * { cursor: pointer !important; }
</style>
</head>

<body>
  <button id="toolbar-toggle" type="button" aria-label="Toggle tools" aria-pressed="false" title="Tools">
    <span class="icon">☰</span>
  </button>

  <div id="toolbar">
    <button onclick="exportSave()">Export Save</button>
    <button onclick="importSave()">Import Save</button>
    <button onclick="exportScenario()">Export Scenario</button>
    <button onclick="importScenario()">Import Scenario</button>
    <button onclick="exportHeightmap()">Export Heightmap</button>
    <button onclick="importHeightmap()">Import Heightmap</button>
    <a href="https://embed.openttdonline.com/" target="_blank">Embed to page</a>
  </div>

  <canvas id="canvas" tabindex="-1"></canvas>

  <div id="overlay">
    <div id="box">
      <h2 id="title">(0 / 42) Loading ...</h2>
      <p id="message">Preparing game ...</p>
    </div>
  </div>

  <img id="logo" src="overgrown.png" alt="Overgrown logo">
  <div id="filesystem">Saving files…</div>

  <script>
    const SAVE_DIR   = '/home/web_user/.openttd/save/';
    const SCEN_DIR   = '/home/web_user/.openttd/scenario/';
    const HEIGHT_DIR = '/home/web_user/.openttd/scenario/heightmap/';

    const toolbar = document.getElementById('toolbar');
    const toggleBtn = document.getElementById('toolbar-toggle');

    const TOOLBAR_KEY = 'openttd_toolbar_visible';
    function setToolbar(visible, {persist=true} = {}){
      toolbar.style.display = visible ? 'flex' : 'none';
      toggleBtn.setAttribute('aria-pressed', visible ? 'true' : 'false');
      if (persist) try{ localStorage.setItem(TOOLBAR_KEY, visible ? '1' : '0'); }catch(_){}
    }
    toggleBtn.addEventListener('click', e=>{
      e.stopPropagation();
      setToolbar(toolbar.style.display !== 'flex');
    });
    try{ setToolbar(localStorage.getItem(TOOLBAR_KEY) === '1', {persist:false}); }catch(_){}

    document.addEventListener('mousedown', e=>{
      if (toolbar.style.display==='flex' && !toolbar.contains(e.target) && !toggleBtn.contains(e.target))
        setToolbar(false);
    });
    document.addEventListener('touchstart', e=>{
      if (toolbar.style.display==='flex' && !toolbar.contains(e.target) && !toggleBtn.contains(e.target))
        setToolbar(false);
    },{passive:true});
    document.addEventListener('keydown', e=>{
      if (e.key==='Escape' && toolbar.style.display==='flex') setToolbar(false);
    });

    function mkdirp(path){
      const parts = path.replace(/\/+$/,'').split('/').filter(Boolean);
      let cur=''; for(const p of parts){ cur+='/'+p; try{ FS.mkdir(cur); }catch(_){ } }
    }
    function newestByMtime(dir,exts){
      try{
        const items=FS.readdir(dir).filter(f=>f!=='.'&&f!=='..')
          .filter(f=>(Array.isArray(exts)?exts:[exts]).some(ext=>f.toLowerCase().endsWith(ext)));
        if(!items.length)return null;
        let best=items[0],t=0;
        for(const f of items){const st=FS.stat(dir+f);if(st&&st.mtime>t){best=f;t=st.mtime;}}
        return best;
      }catch(_){return null;}
    }

    var Module=window.Module||{};
    Module.preRun=[];Module.postRun=[];Module.arguments=[];
    Module.totalDependencies=42;Module.doneDependencies=0;Module.lastDependencies=1;

    Module.print=(...a)=>console.log(a.join(' '));
    Module.printErr=(...a)=>console.error(a.join(' '));
    Module.canvas=(()=>{var e=document.getElementById("canvas");
      e.addEventListener("webglcontextlost",ev=>{alert("WebGL context lost.");ev.preventDefault();},false);
      return e;})();
    Module.setStatus=e=>{
      const n=e&&e.match&&e.match(/^([^(]+)\((\d+(\.\d+)?)\/(\d+)\)$/);
      if(n)e=`(${n[2]} / ${n[4]}) ${n[1]}`;
      document.getElementById("message").innerHTML=e||'';
    };
    Module.monitorRunDependencies=e=>{
      if(e<Module.lastDependencies)Module.doneDependencies++;
      Module.lastDependencies=e;
      const total=Module.totalDependencies,doing=Math.min(Module.doneDependencies+1,total);
      document.getElementById("title").textContent=`(${doing} / ${total}) Loading ...`;
    };

    const download=(name,data,type='application/octet-stream')=>{
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([data],{type}));a.download=name;a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href),100);
    };

    async function exportSave(){try{
      const name=newestByMtime(SAVE_DIR,['.sav']);if(!name)return alert('No save found');
      download(name,FS.readFile(SAVE_DIR+name));
    }catch(e){alert('Export failed:'+e.message);}}
    async function importSave(){const i=document.createElement('input');i.type='file';i.accept='.sav';
      i.onchange=async e=>{const f=e.target.files[0];if(!f)return;
      const b=await f.arrayBuffer();mkdirp(SAVE_DIR);FS.writeFile(SAVE_DIR+f.name,new Uint8Array(b));
      alert('Imported save to '+SAVE_DIR+f.name);};i.click();}

    async function exportScenario(){try{
      const n=newestByMtime(SCEN_DIR,['.scn']);if(!n)return alert('No scenario found');
      download(n,FS.readFile(SCEN_DIR+n));
    }catch(e){alert('Export failed:'+e.message);}}
    async function importScenario(){const i=document.createElement('input');i.type='file';i.accept='.scn';
      i.onchange=async e=>{const f=e.target.files[0];if(!f)return;
      const b=await f.arrayBuffer();mkdirp(SCEN_DIR);FS.writeFile(SCEN_DIR+f.name,new Uint8Array(b));
      alert('Imported scenario to '+SCEN_DIR+f.name);};i.click();}

    async function exportHeightmap(){try{
      const n=newestByMtime(HEIGHT_DIR,['.png','.bmp']);if(!n)return alert('No heightmap found');
      const t=n.toLowerCase().endsWith('.png')?'image/png':'image/bmp';
      download(n,FS.readFile(HEIGHT_DIR+n),t);
    }catch(e){alert('Export failed:'+e.message);}}
    async function importHeightmap(){const i=document.createElement('input');i.type='file';i.accept='.png,.bmp';
      i.onchange=async e=>{const f=e.target.files[0];if(!f)return;
      const b=await f.arrayBuffer();mkdirp(HEIGHT_DIR);FS.writeFile(HEIGHT_DIR+f.name,new Uint8Array(b));
      alert('Imported heightmap to '+HEIGHT_DIR+f.name);};i.click();}
  </script>

  <script src="openttd.js"></script>
</body>
</html>
