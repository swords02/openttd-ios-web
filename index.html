<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OpenTTD Online</title>
<meta name="description" content="Play OpenTTD online directly in your browser â€” build transport empires, connect cities, and manage industries in this classic open-source tycoon game!">
<meta name="keywords" content="OpenTTD online, OpenTTD web, play OpenTTD browser, transport tycoon online, webassembly openttd, open transport tycoon deluxe">

<!-- CSP that allows analytics + Emscripten -->
<meta http-equiv="Content-Security-Policy"
      content="
        default-src 'self' data: blob:;
        script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval' https://static.cloudflareinsights.com;
        script-src-elem 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval' https://static.cloudflareinsights.com;
        script-src-attr 'self' 'unsafe-inline';
        worker-src 'self' blob:;
        connect-src 'self' https://cdn.openttd.org https://servers.openttd.org https://bananas.openttd.org https://cloudflareinsights.com https://*.cloudflareinsights.com;
        img-src 'self' data: blob:;
        style-src 'self' 'unsafe-inline';
        object-src 'none';
        base-uri 'self';
        upgrade-insecure-requests;
      ">

<style>
html,body { margin:0; padding:0; height:100%; width:100%; background:#1a1a1a; display:flex; justify-content:center; align-items:center; overflow:hidden; }
#canvas { width:100%; height:100%; display:block; background:#1a1a1a; }
#overlay { position:absolute; top:0; left:0; right:0; bottom:0; display:flex; justify-content:center; align-items:center; transition:opacity .3s ease; pointer-events:none; }
#box { text-align:center; color:white; font-family:sans-serif; }
#toolbar { position:absolute; top:10px; left:10px; z-index:10; background:rgba(0,0,0,0.5); border-radius:8px; padding:5px 10px; }
#toolbar button { color:white; background:#222; border:1px solid #444; border-radius:5px; padding:4px 8px; margin:2px; cursor:pointer; }
#filesystem { display:none; position:fixed; bottom:10px; right:10px; background:rgba(0,0,0,0.6); padding:8px; border-radius:8px; color:#fff; font-size:13px; }
.error { color:red; }
</style>
<link rel="icon" type="image/png" href="favicon.png">
</head>
<body>
<div id="toolbar">
  <button onclick="exportSave()">Export Save</button>
  <button onclick="importSave()">Import Save</button>
</div>

<canvas id="canvas" tabindex="-1"></canvas>

<div id="overlay">
  <div id="box">
    <h2 id="title">(0 / 42) Loading ...</h2>
    <p id="message">Preparing game ...</p>
  </div>
</div>

<div id="filesystem">Saving files...</div>

<script>
/* ---- Fixed Module bootstrap ---- */
var Module = window.Module || {};
Module.preRun  = Module.preRun  || [];
Module.postRun = Module.postRun || [];
Module.arguments = Module.arguments || [];
Module.totalDependencies = Module.totalDependencies || 42;
Module.doneDependencies  = Module.doneDependencies  || 0;
Module.lastDependencies  = Module.lastDependencies  || 1;

Module.print = function(e){ if(arguments.length>1) e=[...arguments].join(" "); console.log(e); };
Module.printErr = function(e){ if(arguments.length>1) e=[...arguments].join(" "); console.error(e); };
Module.canvas = (function(){
  var e=document.getElementById("canvas");
  e.addEventListener("webglcontextlost",function(t){ alert("WebGL context lost. You will need to reload the page."); t.preventDefault(); },false);
  return e;
})();
Module.setStatus = function(e){
  if(document.getElementById("canvas").style.display!=="none"){
    var n=e.match(/^([^(]+)\((\d+(\.\d+)?)\/(\d+)\)$/);
    if(n) e="("+n[2]+" / "+n[4]+") "+n[1];
    document.getElementById("message").innerHTML=e;
  }
};
Module.monitorRunDependencies = function(e){
  if(e<Module.lastDependencies) Module.doneDependencies+=1;
  Module.lastDependencies=e;
  var total=Module.totalDependencies, doing=Module.doneDependencies+1;
  if(doing>total) doing=total;
  document.getElementById("title").innerHTML="("+doing+" / "+total+") Loading ...";
  document.getElementById("message").innerHTML="Preparing game ...";
};
Module.onBootstrap = function(e,n){
  document.getElementById("canvas").style.display="none";
  document.getElementById("title").innerHTML="Missing base graphics";
  document.getElementById("message").innerHTML="OpenTTD is downloading base graphics.<br/><br/>"+e+" / "+n+" bytes downloaded.";
};
Module.onBootstrapFailed = function(){
  document.getElementById("canvas").style.display="none";
  document.getElementById("title").innerHTML="Missing base graphics";
  document.getElementById("message").innerHTML="Failed to download base graphics.<br/>The game cannot start without base graphics.<br/><br/>Please check your Internet connection and/or the console log.<br/>Reload your browser to try again.";
};
Module.onBootstrapReload = function(){
  document.getElementById("canvas").style.display="none";
  document.getElementById("title").innerHTML="Missing base graphics";
  document.getElementById("message").innerHTML="Downloading base graphics done.<br/><br/>Your browser will reload to start the game.";
};
Module.onExit = function(){
  document.getElementById("canvas").style.display="none";
  document.getElementById("title").innerHTML="Thank you for playing!";
  document.getElementById("message").innerHTML="We hope you enjoyed OpenTTD!<br/><br/>Reload your browser to restart the game.";
};
Module.onAbort = function(){
  document.getElementById("canvas").style.display="none";
  document.getElementById("box").className="error";
  document.getElementById("title").innerHTML="Crash :(";
  document.getElementById("message").innerHTML="The game crashed!<br/><br/>Please reload your browser to restart the game.";
};
Module.onWarningFs = function(){
  document.getElementById("filesystem").style.display="inline-block";
  document.getElementById("overlay").style.opacity = 1;
  setTimeout(function(){
    document.getElementById("overlay").style.opacity = 0;
    setTimeout(function(){
      document.getElementById("filesystem").style.display = "none";
    }, 300);
  }, 10000);
};
window.onerror=function(){ Module.onAbort(); };
Module.locateFile = function (p) { return p; };
</script>

<script>
async function exportSave() {
  try {
    const data = await FS.readFile('/.openttd/save/autosave.sav');
    const blob = new Blob([data], { type: 'application/octet-stream' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'openttd_save.sav';
    a.click();
  } catch (e) {
    alert('Export failed: ' + e.message);
  }
}

async function importSave() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.sav';
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const arrayBuffer = await file.arrayBuffer();
    FS.writeFile('/.openttd/save/imported.sav', new Uint8Array(arrayBuffer));
    alert('Save imported! Load it in-game via the "Load Game" menu.');
  };
  input.click();
}
</script>

<!-- Load Emscripten build last -->
<script src="openttd.js"></script>
</body>
</html>
